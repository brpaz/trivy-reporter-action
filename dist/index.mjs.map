{"version":3,"file":"index.mjs","names":["counts: SeverityCounts","results: IssueResult[]","issueMode: IssueMode"],"sources":["../src/trivy.ts","../src/issue.ts","../src/main.ts","../src/index.ts"],"sourcesContent":["import * as fs from 'fs/promises'\n\nexport interface TrivyReport {\n  Results: TrivyResult[]\n}\n\nexport interface TrivyResult {\n  Target: string\n  Class: string\n  Type: string\n  Vulnerabilities: TrivyVulnerability[]\n}\n\nexport interface TrivyVulnerability {\n  VulnerabilityID: string\n  PkgName: string\n  InstalledVersion: string\n  FixedVersion: string\n  Severity: string\n  Title: string\n  Description: string\n  References: string[]\n  PrimaryURL?: string\n  CweIDs?: string[]\n  PublishedDate?: string\n  LastModifiedDate?: string\n}\n\n/**\n * This function is responsible for parsing the Trivy report and return a structure with it¬¥s output.\n */\nexport async function parseTrivyReport(\n  reportPath: string,\n): Promise<TrivyReport> {\n  try {\n    // Read the file contents\n    const fileContents = await fs.readFile(reportPath, 'utf-8')\n\n    // Parse the JSON\n    const report = JSON.parse(fileContents) as TrivyReport\n\n    // Validate that Results field exists\n    if (!report.Results) {\n      throw new Error('Invalid Trivy report: missing Results field')\n    }\n\n    // Ensure Results is an array (even if empty)\n    if (!Array.isArray(report.Results)) {\n      throw new Error('Invalid Trivy report: Results must be an array')\n    }\n\n    return report\n  } catch (error) {\n    if (error instanceof Error) {\n      // Handle specific error types\n      if ('code' in error && error.code === 'ENOENT') {\n        throw new Error(`Trivy report file not found: ${reportPath}`)\n      }\n      if (error.name === 'SyntaxError') {\n        throw new Error(`Invalid JSON in Trivy report file: ${reportPath}`)\n      }\n      // Re-throw other errors with context\n      throw new Error(`Failed to parse Trivy report: ${error.message}`)\n    }\n    throw error\n  }\n}\n","import { type TrivyReport, type TrivyVulnerability } from './trivy.js'\nimport { GitHub } from '@actions/github/lib/utils.js'\n\n// GitHub issue body size limit (leaving some buffer)\nconst MAX_ISSUE_BODY_SIZE = 60000\n\n// GitHub issue title limit\nconst MAX_ISSUE_TITLE_LENGTH = 256\n\nexport type IssueMode = 'single' | 'per-cve'\n\nexport interface VulnerabilityOccurrence {\n  target: string\n  pkgName: string\n  installedVersion: string\n  fixedVersion: string\n  type: string\n  class: string\n}\n\nexport interface AggregatedVulnerability {\n  vulnerabilityId: string\n  severity: string\n  title: string\n  description: string\n  references: string[]\n  primaryUrl?: string\n  cweIds?: string[]\n  publishedDate?: string\n  lastModifiedDate?: string\n  occurrences: VulnerabilityOccurrence[]\n}\n\ninterface SeverityCounts {\n  CRITICAL: number\n  HIGH: number\n  MEDIUM: number\n  LOW: number\n  UNKNOWN: number\n}\n\n/**\n * Count vulnerabilities by severity\n */\nfunction countBySeverity(report: TrivyReport): SeverityCounts {\n  const counts: SeverityCounts = {\n    CRITICAL: 0,\n    HIGH: 0,\n    MEDIUM: 0,\n    LOW: 0,\n    UNKNOWN: 0,\n  }\n\n  for (const result of report.Results) {\n    if (!result.Vulnerabilities) continue\n\n    for (const vuln of result.Vulnerabilities) {\n      const severity = vuln.Severity?.toUpperCase() || 'UNKNOWN'\n      if (severity in counts) {\n        counts[severity as keyof SeverityCounts]++\n      } else {\n        counts.UNKNOWN++\n      }\n    }\n  }\n\n  return counts\n}\n\n/**\n * Get total vulnerability count\n */\nfunction getTotalCount(counts: SeverityCounts): number {\n  return (\n    counts.CRITICAL + counts.HIGH + counts.MEDIUM + counts.LOW + counts.UNKNOWN\n  )\n}\n\n/**\n * Group vulnerabilities by severity\n */\nfunction groupBySeverity(\n  vulnerabilities: TrivyVulnerability[],\n): Map<string, TrivyVulnerability[]> {\n  const groups = new Map<string, TrivyVulnerability[]>()\n  const severityOrder = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'UNKNOWN']\n\n  // Initialize groups in order\n  for (const severity of severityOrder) {\n    groups.set(severity, [])\n  }\n\n  // Group vulnerabilities\n  for (const vuln of vulnerabilities) {\n    const severity = vuln.Severity?.toUpperCase() || 'UNKNOWN'\n    const group = groups.get(severity)\n    if (group) {\n      group.push(vuln)\n    } else {\n      // If severity not in our list, add to UNKNOWN\n      groups.get('UNKNOWN')!.push(vuln)\n    }\n  }\n\n  return groups\n}\n\n/**\n * Truncate text to specified length with ellipsis\n */\nfunction truncateText(text: string, maxLength: number): string {\n  if (!text || text.length <= maxLength) return text || 'N/A'\n  return text.substring(0, maxLength) + '...'\n}\n\n/**\n * Generate markdown table for vulnerabilities of a specific severity\n */\nfunction generateVulnerabilityTable(\n  vulnerabilities: TrivyVulnerability[],\n): string {\n  if (vulnerabilities.length === 0) return ''\n\n  let table =\n    '\\n| Package | Vulnerability ID | Installed Version | Fixed Version | Description |\\n'\n  table +=\n    '|---------|------------------|-------------------|---------------|-------------|\\n'\n\n  for (const vuln of vulnerabilities) {\n    const vulnId = vuln.PrimaryURL\n      ? `[${vuln.VulnerabilityID}](${vuln.PrimaryURL})`\n      : vuln.VulnerabilityID\n    const pkgName = vuln.PkgName || 'N/A'\n    const installedVersion = vuln.InstalledVersion || 'N/A'\n    const fixedVersion = vuln.FixedVersion || 'Not Available'\n    const description = truncateText(\n      vuln.Description || vuln.Title || 'No description available',\n      100,\n    )\n\n    table += `| ${pkgName} | ${vulnId} | ${installedVersion} | ${fixedVersion} | ${description} |\\n`\n  }\n\n  return table\n}\n\n/**\n * Aggregate vulnerabilities by VulnerabilityID across all results\n */\nexport function aggregateVulnerabilities(\n  trivyReport: TrivyReport,\n): Map<string, AggregatedVulnerability> {\n  const aggregated = new Map<string, AggregatedVulnerability>()\n\n  for (const result of trivyReport.Results) {\n    if (!result.Vulnerabilities) continue\n\n    for (const vuln of result.Vulnerabilities) {\n      const vulnId = vuln.VulnerabilityID\n\n      if (!aggregated.has(vulnId)) {\n        // First occurrence of this vulnerability\n        aggregated.set(vulnId, {\n          vulnerabilityId: vulnId,\n          severity: vuln.Severity || 'UNKNOWN',\n          title: vuln.Title || '',\n          description: vuln.Description || '',\n          references: vuln.References || [],\n          primaryUrl: vuln.PrimaryURL,\n          cweIds: vuln.CweIDs,\n          publishedDate: vuln.PublishedDate,\n          lastModifiedDate: vuln.LastModifiedDate,\n          occurrences: [],\n        })\n      }\n\n      // Add this occurrence\n      const agg = aggregated.get(vulnId)!\n      agg.occurrences.push({\n        target: result.Target,\n        pkgName: vuln.PkgName,\n        installedVersion: vuln.InstalledVersion,\n        fixedVersion: vuln.FixedVersion,\n        type: result.Type,\n        class: result.Class,\n      })\n    }\n  }\n\n  return aggregated\n}\n\n/**\n * Search for an existing CVE issue by vulnerability ID\n */\nasync function findExistingCveIssue(\n  octokit: InstanceType<typeof GitHub>,\n  owner: string,\n  repo: string,\n  vulnId: string,\n): Promise<number | null> {\n  try {\n    const { data: issues } = await octokit.rest.issues.listForRepo({\n      owner,\n      repo,\n      state: 'open',\n      creator: 'github-actions[bot]',\n      per_page: 100,\n    })\n\n    const titlePrefix = `[Security] ${vulnId}:`\n    const existingIssue = issues.find((issue) =>\n      issue.title.startsWith(titlePrefix),\n    )\n    return existingIssue ? existingIssue.number : null\n  } catch (error) {\n    console.warn('Failed to search for existing CVE issues:', error)\n    return null\n  }\n}\n\n/**\n * Generate markdown report for a single CVE\n */\nexport function generateCveMarkdownReport(\n  vuln: AggregatedVulnerability,\n): string {\n  const timestamp = new Date().toISOString()\n\n  // Get severity emoji\n  const severityEmoji =\n    {\n      CRITICAL: 'üî¥',\n      HIGH: 'üü†',\n      MEDIUM: 'üü°',\n      LOW: 'üü¢',\n      UNKNOWN: '‚ö™',\n    }[vuln.severity.toUpperCase()] || '‚ö™'\n\n  let markdown = `# ${severityEmoji} ${vuln.severity.toUpperCase()} Severity\\n\\n`\n  markdown += `## Vulnerability: ${vuln.vulnerabilityId}\\n\\n`\n\n  // Description\n  markdown += '### üìã Description\\n\\n'\n  markdown += `${vuln.description || 'No description available'}\\n\\n`\n\n  // Title if different from description\n  if (vuln.title && vuln.title !== vuln.description) {\n    markdown += `**Title:** ${vuln.title}\\n\\n`\n  }\n\n  // CWE IDs\n  if (vuln.cweIds && vuln.cweIds.length > 0) {\n    markdown += `**CWE IDs:** ${vuln.cweIds.join(', ')}\\n\\n`\n  }\n\n  // References\n  if (vuln.references && vuln.references.length > 0) {\n    markdown += '### üîó References\\n\\n'\n    for (const ref of vuln.references.slice(0, 10)) {\n      // Limit to 10 references\n      markdown += `- ${ref}\\n`\n    }\n    if (vuln.references.length > 10) {\n      markdown += `\\n*... and ${vuln.references.length - 10} more references*\\n`\n    }\n    markdown += '\\n'\n  }\n\n  // Affected packages table\n  markdown += '### üì¶ Affected Packages\\n\\n'\n  markdown +=\n    '| Target | Package | Installed Version | Fixed Version | Type | Class |\\n'\n  markdown +=\n    '|--------|---------|-------------------|---------------|------|-------|\\n'\n\n  for (const occ of vuln.occurrences) {\n    const target = truncateText(occ.target, 40)\n    const pkgName = occ.pkgName || 'N/A'\n    const installedVersion = occ.installedVersion || 'N/A'\n    const fixedVersion = occ.fixedVersion || 'Not Available'\n    const type = occ.type || 'N/A'\n    const classValue = occ.class || 'N/A'\n\n    markdown += `| ${target} | ${pkgName} | ${installedVersion} | ${fixedVersion} | ${type} | ${classValue} |\\n`\n  }\n\n  markdown += '\\n'\n\n  // Metadata\n  markdown += '---\\n\\n'\n  if (vuln.publishedDate) {\n    markdown += `**Published:** ${vuln.publishedDate}\\n\\n`\n  }\n  if (vuln.lastModifiedDate) {\n    markdown += `**Last Modified:** ${vuln.lastModifiedDate}\\n\\n`\n  }\n  markdown += `*Report generated on: ${timestamp}*\\n\\n`\n  markdown += '*Powered by [Trivy](https://trivy.dev/)*\\n'\n\n  // Truncate if too large\n  if (markdown.length > MAX_ISSUE_BODY_SIZE) {\n    const truncateMessage =\n      '\\n\\n---\\n\\n‚ö†Ô∏è **Note:** This report was truncated due to size limitations. Please check the full Trivy report file for complete details.\\n'\n    markdown =\n      markdown.substring(0, MAX_ISSUE_BODY_SIZE - truncateMessage.length) +\n      truncateMessage\n  }\n\n  return markdown\n}\n\n/**\n * Create issue title for a CVE\n */\nfunction createCveIssueTitle(vuln: AggregatedVulnerability): string {\n  const prefix = `[Security] ${vuln.vulnerabilityId}:`\n  const titleText = vuln.title || vuln.description || 'Security vulnerability'\n\n  // Calculate remaining space for title\n  const remainingSpace = MAX_ISSUE_TITLE_LENGTH - prefix.length - 1 // -1 for space\n\n  if (titleText.length <= remainingSpace) {\n    return `${prefix} ${titleText}`\n  }\n\n  // Truncate title to fit\n  return `${prefix} ${titleText.substring(0, remainingSpace - 3)}...`\n}\n\n/**\n * Create or update a single CVE issue\n */\nasync function createOrUpdateCveIssue(\n  octokit: InstanceType<typeof GitHub>,\n  owner: string,\n  repo: string,\n  vuln: AggregatedVulnerability,\n  labels: string[],\n): Promise<IssueResult> {\n  const issueTitle = createCveIssueTitle(vuln)\n  const markdownBody = generateCveMarkdownReport(vuln)\n\n  // Search for existing issue\n  const existingIssueNumber = await findExistingCveIssue(\n    octokit,\n    owner,\n    repo,\n    vuln.vulnerabilityId,\n  )\n\n  // Update existing issue\n  if (existingIssueNumber) {\n    await octokit.rest.issues.update({\n      owner,\n      repo,\n      issue_number: existingIssueNumber,\n      title: issueTitle,\n      body: markdownBody,\n      labels: labels.length > 0 ? labels : undefined,\n    })\n\n    const timestamp = new Date().toISOString()\n    await octokit.rest.issues.createComment({\n      owner,\n      repo,\n      issue_number: existingIssueNumber,\n      body: `üîÑ Report updated on ${timestamp}`,\n    })\n\n    const issueUrl = `https://github.com/${owner}/${repo}/issues/${existingIssueNumber}`\n    return {\n      issueNumber: existingIssueNumber,\n      issueUrl,\n      vulnerabilitiesFound: true,\n    }\n  }\n\n  // Create new issue\n  const { data: newIssue } = await octokit.rest.issues.create({\n    owner,\n    repo,\n    title: issueTitle,\n    body: markdownBody,\n    labels: labels.length > 0 ? labels : undefined,\n  })\n\n  return {\n    issueNumber: newIssue.number,\n    issueUrl: newIssue.html_url,\n    vulnerabilitiesFound: true,\n  }\n}\n\n/**\n * Close a CVE issue that no longer has vulnerabilities\n */\nasync function closeCveIssue(\n  octokit: InstanceType<typeof GitHub>,\n  owner: string,\n  repo: string,\n  issueNumber: number,\n  vulnId: string,\n): Promise<void> {\n  const timestamp = new Date().toISOString()\n  await octokit.rest.issues.createComment({\n    owner,\n    repo,\n    issue_number: issueNumber,\n    body: `‚úÖ This vulnerability (${vulnId}) is no longer detected in the latest scan.\\n\\n*Auto-closed on ${timestamp}*`,\n  })\n\n  await octokit.rest.issues.update({\n    owner,\n    repo,\n    issue_number: issueNumber,\n    state: 'closed',\n  })\n}\n\n/**\n * Generate markdown report from Trivy results\n */\nexport function generateMarkdownReport(trivyReport: TrivyReport): string {\n  const counts = countBySeverity(trivyReport)\n  const total = getTotalCount(counts)\n  const timestamp = new Date().toISOString()\n\n  let markdown = '# üîí Trivy Security Report\\n\\n'\n\n  // Summary section\n  markdown += '## üìä Summary\\n\\n'\n  markdown += '| Severity | Count |\\n'\n  markdown += '|----------|-------|\\n'\n  markdown += `| üî¥ CRITICAL | ${counts.CRITICAL} |\\n`\n  markdown += `| üü† HIGH | ${counts.HIGH} |\\n`\n  markdown += `| üü° MEDIUM | ${counts.MEDIUM} |\\n`\n  markdown += `| üü¢ LOW | ${counts.LOW} |\\n`\n  if (counts.UNKNOWN > 0) {\n    markdown += `| ‚ö™ UNKNOWN | ${counts.UNKNOWN} |\\n`\n  }\n  markdown += `| **üìà Total** | **${total}** |\\n\\n`\n\n  // Process each target\n  for (const result of trivyReport.Results) {\n    if (!result.Vulnerabilities || result.Vulnerabilities.length === 0) {\n      continue\n    }\n\n    markdown += '---\\n\\n'\n    markdown += `## üì¶ Target: ${result.Target}\\n\\n`\n    markdown += `**Type:** ${result.Type || 'N/A'} | **Class:** ${result.Class || 'N/A'}\\n\\n`\n\n    // Group vulnerabilities by severity\n    const grouped = groupBySeverity(result.Vulnerabilities)\n\n    // Generate sections for each severity level\n    for (const [severity, vulns] of grouped.entries()) {\n      if (vulns.length === 0) continue\n\n      const emoji =\n        {\n          CRITICAL: 'üî¥',\n          HIGH: 'üü†',\n          MEDIUM: 'üü°',\n          LOW: 'üü¢',\n          UNKNOWN: '‚ö™',\n        }[severity] || '‚ö™'\n\n      markdown += `### ${emoji} ${severity} (${vulns.length})\\n`\n      markdown += generateVulnerabilityTable(vulns)\n      markdown += '\\n'\n    }\n  }\n\n  markdown += '---\\n\\n'\n  markdown += `*Report generated on: ${timestamp}*\\n\\n`\n  markdown += '*Powered by [Trivy](https://trivy.dev/)*\\n'\n\n  // Truncate if too large\n  if (markdown.length > MAX_ISSUE_BODY_SIZE) {\n    const truncateMessage =\n      '\\n\\n---\\n\\n‚ö†Ô∏è **Note:** This report was truncated due to size limitations. Please check the full Trivy report file for complete details.\\n'\n    markdown =\n      markdown.substring(0, MAX_ISSUE_BODY_SIZE - truncateMessage.length) +\n      truncateMessage\n  }\n\n  return markdown\n}\n\nexport type IssueResult = {\n  issueNumber: number | undefined\n  issueUrl: string | undefined\n  vulnerabilitiesFound: boolean\n}\n\n/**\n * Search for an existing issue with the given title\n */\nasync function findExistingIssue(\n  octokit: InstanceType<typeof GitHub>,\n  owner: string,\n  repo: string,\n  issueTitle: string,\n): Promise<number | null> {\n  try {\n    const { data: issues } = await octokit.rest.issues.listForRepo({\n      owner,\n      repo,\n      state: 'open',\n      creator: 'github-actions[bot]',\n      per_page: 100,\n    })\n\n    const existingIssue = issues.find((issue) => issue.title === issueTitle)\n    return existingIssue ? existingIssue.number : null\n  } catch (error) {\n    // If we can't search, we'll just create a new issue\n    console.warn('Failed to search for existing issues:', error)\n    return null\n  }\n}\n\n/**\n * Function that creates or updates GitHub issues based on a Trivy report.\n * @param octokit The Octokit GitHub instance.\n * @param owner Repository owner\n * @param repo Repository name\n * @param trivyReport The parsed Trivy report\n * @param issueTitle The title for the issue (only used in single mode)\n * @param labels Optional labels to apply\n * @param issueMode Mode for issue creation: 'single' or 'per-cve'\n * @returns Issue result or array of issue results\n */\nexport async function createOrUpdateIssue(\n  octokit: InstanceType<typeof GitHub>,\n  owner: string,\n  repo: string,\n  trivyReport: TrivyReport,\n  issueTitle: string,\n  labels?: string[],\n  issueMode: IssueMode = 'single',\n): Promise<IssueResult | IssueResult[]> {\n  // Handle per-cve mode\n  if (issueMode === 'per-cve') {\n    return await handlePerCveMode(\n      octokit,\n      owner,\n      repo,\n      trivyReport,\n      labels || [],\n    )\n  }\n\n  // Handle single mode (original behavior)\n  return await handleSingleMode(\n    octokit,\n    owner,\n    repo,\n    trivyReport,\n    issueTitle,\n    labels,\n  )\n}\n\n/**\n * Handle per-CVE issue mode\n */\nasync function handlePerCveMode(\n  octokit: InstanceType<typeof GitHub>,\n  owner: string,\n  repo: string,\n  trivyReport: TrivyReport,\n  labels: string[],\n): Promise<IssueResult[]> {\n  const results: IssueResult[] = []\n\n  // Aggregate vulnerabilities by ID\n  const aggregated = aggregateVulnerabilities(trivyReport)\n\n  // Track current vulnerability IDs\n  const currentVulnIds = new Set(aggregated.keys())\n\n  // Create or update issues for each vulnerability\n  for (const vuln of aggregated.values()) {\n    const result = await createOrUpdateCveIssue(\n      octokit,\n      owner,\n      repo,\n      vuln,\n      labels,\n    )\n    results.push(result)\n  }\n\n  // Find and close issues for resolved vulnerabilities\n  try {\n    const { data: issues } = await octokit.rest.issues.listForRepo({\n      owner,\n      repo,\n      state: 'open',\n      creator: 'github-actions[bot]',\n      per_page: 100,\n    })\n\n    for (const issue of issues) {\n      // Check if this is a CVE issue\n      const match = issue.title.match(/^\\[Security\\] ([A-Z]+-\\d+-\\d+):/)\n      if (match) {\n        const vulnId = match[1]\n        // If this vulnerability is not in the current scan, close it\n        if (!currentVulnIds.has(vulnId)) {\n          await closeCveIssue(octokit, owner, repo, issue.number, vulnId)\n          results.push({\n            issueNumber: issue.number,\n            issueUrl: issue.html_url,\n            vulnerabilitiesFound: false,\n          })\n        }\n      }\n    }\n  } catch (error) {\n    console.warn('Failed to check for resolved vulnerabilities:', error)\n  }\n\n  return results\n}\n\n/**\n * Handle single issue mode (original behavior)\n */\nasync function handleSingleMode(\n  octokit: InstanceType<typeof GitHub>,\n  owner: string,\n  repo: string,\n  trivyReport: TrivyReport,\n  issueTitle: string,\n  labels?: string[],\n): Promise<IssueResult> {\n  // Count total vulnerabilities\n  const counts = countBySeverity(trivyReport)\n  const totalVulns = getTotalCount(counts)\n\n  // Search for existing issue\n  const existingIssueNumber = await findExistingIssue(\n    octokit,\n    owner,\n    repo,\n    issueTitle,\n  )\n\n  // If no vulnerabilities found, close existing issue if it exists\n  if (totalVulns === 0) {\n    if (existingIssueNumber) {\n      await octokit.rest.issues.update({\n        owner,\n        repo,\n        issue_number: existingIssueNumber,\n        state: 'closed',\n      })\n\n      const issueUrl = `https://github.com/${owner}/${repo}/issues/${existingIssueNumber}`\n      return {\n        issueNumber: existingIssueNumber,\n        issueUrl,\n        vulnerabilitiesFound: false,\n      }\n    }\n\n    // No existing issue and no vulnerabilities - nothing to do\n    return {\n      issueNumber: undefined,\n      issueUrl: undefined,\n      vulnerabilitiesFound: false,\n    }\n  }\n\n  // Generate markdown report\n  const markdownBody = generateMarkdownReport(trivyReport)\n\n  // Update existing issue\n  if (existingIssueNumber) {\n    await octokit.rest.issues.update({\n      owner,\n      repo,\n      issue_number: existingIssueNumber,\n      body: markdownBody,\n      labels: labels && labels.length > 0 ? labels : undefined,\n    })\n\n    const timestamp = new Date().toISOString()\n    await octokit.rest.issues.createComment({\n      owner,\n      repo,\n      issue_number: existingIssueNumber,\n      body: `üîÑ Report updated on ${timestamp}`,\n    })\n\n    const issueUrl = `https://github.com/${owner}/${repo}/issues/${existingIssueNumber}`\n    return {\n      issueNumber: existingIssueNumber,\n      issueUrl,\n      vulnerabilitiesFound: true,\n    }\n  }\n\n  // Create new issue\n  const { data: newIssue } = await octokit.rest.issues.create({\n    owner,\n    repo,\n    title: issueTitle,\n    body: markdownBody,\n    labels: labels && labels.length > 0 ? labels : undefined,\n  })\n\n  return {\n    issueNumber: newIssue.number,\n    issueUrl: newIssue.html_url,\n    vulnerabilitiesFound: true,\n  }\n}\n","import * as core from '@actions/core'\nimport { getOctokit, context } from '@actions/github'\nimport { parseTrivyReport } from './trivy.js'\nimport { createOrUpdateIssue, type IssueMode } from './issue.js'\n\n/**\n * The main function for the action.\n * @returns {Promise<void>} Resolves when the action is complete.\n */\nexport async function run(): Promise<void> {\n  try {\n    const reportPath = core.getInput('report-path', { required: true })\n    const issueTitle = core.getInput('issue-title', { required: true })\n    const githubToken = core.getInput('github-token', { required: true })\n    const labelsInput = core.getInput('labels', { required: false })\n    const issueModeInput = core.getInput('issue-mode', { required: false })\n\n    const labels = labelsInput\n      ? labelsInput\n          .split(',')\n          .map((l) => l.trim())\n          .filter((l) => l.length > 0)\n      : []\n\n    // Validate issue mode\n    const issueMode: IssueMode =\n      issueModeInput === 'per-cve' ? 'per-cve' : 'single'\n    if (\n      issueModeInput &&\n      issueModeInput !== 'single' &&\n      issueModeInput !== 'per-cve'\n    ) {\n      core.warning(\n        `Invalid issue-mode '${issueModeInput}'. Using default 'single' mode.`,\n      )\n    }\n\n    const octokit = getOctokit(githubToken)\n    const { owner, repo } = context.repo\n\n    core.info(`üìÑ Parsing Trivy report from: ${reportPath}`)\n\n    const trivyReport = await parseTrivyReport(reportPath)\n\n    const result = await createOrUpdateIssue(\n      octokit,\n      owner,\n      repo,\n      trivyReport,\n      issueTitle,\n      labels,\n      issueMode,\n    )\n\n    // Handle output based on mode\n    if (Array.isArray(result)) {\n      // Per-CVE mode: multiple issues\n      const createdOrUpdated = result.filter((r) => r.vulnerabilitiesFound)\n      const closed = result.filter((r) => !r.vulnerabilitiesFound)\n\n      if (createdOrUpdated.length > 0) {\n        core.info(\n          `‚úÖ Created or updated ${createdOrUpdated.length} issue(s) for vulnerabilities`,\n        )\n        for (const r of createdOrUpdated) {\n          core.info(`   - Issue #${r.issueNumber}: ${r.issueUrl}`)\n        }\n        // Set output to first issue URL (for backward compatibility)\n        core.setOutput('issue-url', createdOrUpdated[0].issueUrl)\n      }\n\n      if (closed.length > 0) {\n        core.info(`üîí Closed ${closed.length} resolved vulnerability issue(s)`)\n      }\n\n      if (createdOrUpdated.length === 0 && closed.length === 0) {\n        core.info('‚úÖ No vulnerabilities found')\n      }\n    } else {\n      // Single mode: one issue\n      if (result.vulnerabilitiesFound) {\n        core.setOutput('issue-url', result.issueUrl)\n        core.info(`‚úÖ Issue #${result.issueNumber} updated successfully`)\n        core.info(`üîó ${result.issueUrl}`)\n      } else {\n        core.info('‚úÖ No vulnerabilities found')\n      }\n    }\n  } catch (error) {\n    if (error instanceof Error) {\n      core.setFailed(`‚ùå Action failed: ${error.message}`)\n    } else {\n      core.setFailed('‚ùå An unknown error occurred')\n    }\n  }\n}\n","/**\n * The entrypoint for the action.\n */\nimport { run } from './main.js'\n\nrun()\n"],"mappings":"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"}