{"version":3,"file":"index.mjs","names":["counts: SeverityCounts"],"sources":["../src/trivy.ts","../src/issue.ts","../src/main.ts","../src/index.ts"],"sourcesContent":["import * as fs from 'fs/promises'\n\nexport interface TrivyReport {\n  Results: TrivyResult[]\n}\n\nexport interface TrivyResult {\n  Target: string\n  Class: string\n  Type: string\n  Vulnerabilities: TrivyVulnerability[]\n}\n\nexport interface TrivyVulnerability {\n  VulnerabilityID: string\n  PkgName: string\n  InstalledVersion: string\n  FixedVersion: string\n  Severity: string\n  Title: string\n  Description: string\n  References: string[]\n  PrimaryURL?: string\n}\n\n/**\n * This function is responsible for parsing the Trivy report and return a structure with it¬¥s output.\n */\nexport async function parseTrivyReport(\n  reportPath: string,\n): Promise<TrivyReport> {\n  try {\n    // Read the file contents\n    const fileContents = await fs.readFile(reportPath, 'utf-8')\n\n    // Parse the JSON\n    const report = JSON.parse(fileContents) as TrivyReport\n\n    // Validate that Results field exists\n    if (!report.Results) {\n      throw new Error('Invalid Trivy report: missing Results field')\n    }\n\n    // Ensure Results is an array (even if empty)\n    if (!Array.isArray(report.Results)) {\n      throw new Error('Invalid Trivy report: Results must be an array')\n    }\n\n    return report\n  } catch (error) {\n    if (error instanceof Error) {\n      // Handle specific error types\n      if ('code' in error && error.code === 'ENOENT') {\n        throw new Error(`Trivy report file not found: ${reportPath}`)\n      }\n      if (error.name === 'SyntaxError') {\n        throw new Error(`Invalid JSON in Trivy report file: ${reportPath}`)\n      }\n      // Re-throw other errors with context\n      throw new Error(`Failed to parse Trivy report: ${error.message}`)\n    }\n    throw error\n  }\n}\n","import { type TrivyReport, type TrivyVulnerability } from './trivy.js'\nimport { GitHub } from '@actions/github/lib/utils.js'\n\n// GitHub issue body size limit (leaving some buffer)\nconst MAX_ISSUE_BODY_SIZE = 60000\n\ninterface SeverityCounts {\n  CRITICAL: number\n  HIGH: number\n  MEDIUM: number\n  LOW: number\n  UNKNOWN: number\n}\n\n/**\n * Count vulnerabilities by severity\n */\nfunction countBySeverity(report: TrivyReport): SeverityCounts {\n  const counts: SeverityCounts = {\n    CRITICAL: 0,\n    HIGH: 0,\n    MEDIUM: 0,\n    LOW: 0,\n    UNKNOWN: 0,\n  }\n\n  for (const result of report.Results) {\n    if (!result.Vulnerabilities) continue\n\n    for (const vuln of result.Vulnerabilities) {\n      const severity = vuln.Severity?.toUpperCase() || 'UNKNOWN'\n      if (severity in counts) {\n        counts[severity as keyof SeverityCounts]++\n      } else {\n        counts.UNKNOWN++\n      }\n    }\n  }\n\n  return counts\n}\n\n/**\n * Get total vulnerability count\n */\nfunction getTotalCount(counts: SeverityCounts): number {\n  return (\n    counts.CRITICAL + counts.HIGH + counts.MEDIUM + counts.LOW + counts.UNKNOWN\n  )\n}\n\n/**\n * Group vulnerabilities by severity\n */\nfunction groupBySeverity(\n  vulnerabilities: TrivyVulnerability[],\n): Map<string, TrivyVulnerability[]> {\n  const groups = new Map<string, TrivyVulnerability[]>()\n  const severityOrder = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'UNKNOWN']\n\n  // Initialize groups in order\n  for (const severity of severityOrder) {\n    groups.set(severity, [])\n  }\n\n  // Group vulnerabilities\n  for (const vuln of vulnerabilities) {\n    const severity = vuln.Severity?.toUpperCase() || 'UNKNOWN'\n    const group = groups.get(severity)\n    if (group) {\n      group.push(vuln)\n    } else {\n      // If severity not in our list, add to UNKNOWN\n      groups.get('UNKNOWN')!.push(vuln)\n    }\n  }\n\n  return groups\n}\n\n/**\n * Truncate text to specified length with ellipsis\n */\nfunction truncateText(text: string, maxLength: number): string {\n  if (!text || text.length <= maxLength) return text || 'N/A'\n  return text.substring(0, maxLength) + '...'\n}\n\n/**\n * Generate markdown table for vulnerabilities of a specific severity\n */\nfunction generateVulnerabilityTable(\n  vulnerabilities: TrivyVulnerability[],\n): string {\n  if (vulnerabilities.length === 0) return ''\n\n  let table =\n    '\\n| Package | Vulnerability ID | Installed Version | Fixed Version | Description |\\n'\n  table +=\n    '|---------|------------------|-------------------|---------------|-------------|\\n'\n\n  for (const vuln of vulnerabilities) {\n    const vulnId = vuln.PrimaryURL\n      ? `[${vuln.VulnerabilityID}](${vuln.PrimaryURL})`\n      : vuln.VulnerabilityID\n    const pkgName = vuln.PkgName || 'N/A'\n    const installedVersion = vuln.InstalledVersion || 'N/A'\n    const fixedVersion = vuln.FixedVersion || 'Not Available'\n    const description = truncateText(\n      vuln.Description || vuln.Title || 'No description available',\n      100,\n    )\n\n    table += `| ${pkgName} | ${vulnId} | ${installedVersion} | ${fixedVersion} | ${description} |\\n`\n  }\n\n  return table\n}\n\n/**\n * Generate markdown report from Trivy results\n */\nexport function generateMarkdownReport(trivyReport: TrivyReport): string {\n  const counts = countBySeverity(trivyReport)\n  const total = getTotalCount(counts)\n  const timestamp = new Date().toISOString()\n\n  let markdown = '# üîí Trivy Security Report\\n\\n'\n\n  // Summary section\n  markdown += '## üìä Summary\\n\\n'\n  markdown += '| Severity | Count |\\n'\n  markdown += '|----------|-------|\\n'\n  markdown += `| üî¥ CRITICAL | ${counts.CRITICAL} |\\n`\n  markdown += `| üü† HIGH | ${counts.HIGH} |\\n`\n  markdown += `| üü° MEDIUM | ${counts.MEDIUM} |\\n`\n  markdown += `| üü¢ LOW | ${counts.LOW} |\\n`\n  if (counts.UNKNOWN > 0) {\n    markdown += `| ‚ö™ UNKNOWN | ${counts.UNKNOWN} |\\n`\n  }\n  markdown += `| **üìà Total** | **${total}** |\\n\\n`\n\n  // Process each target\n  for (const result of trivyReport.Results) {\n    if (!result.Vulnerabilities || result.Vulnerabilities.length === 0) {\n      continue\n    }\n\n    markdown += '---\\n\\n'\n    markdown += `## üì¶ Target: ${result.Target}\\n\\n`\n    markdown += `**Type:** ${result.Type || 'N/A'} | **Class:** ${result.Class || 'N/A'}\\n\\n`\n\n    // Group vulnerabilities by severity\n    const grouped = groupBySeverity(result.Vulnerabilities)\n\n    // Generate sections for each severity level\n    for (const [severity, vulns] of grouped.entries()) {\n      if (vulns.length === 0) continue\n\n      const emoji =\n        {\n          CRITICAL: 'üî¥',\n          HIGH: 'üü†',\n          MEDIUM: 'üü°',\n          LOW: 'üü¢',\n          UNKNOWN: '‚ö™',\n        }[severity] || '‚ö™'\n\n      markdown += `### ${emoji} ${severity} (${vulns.length})\\n`\n      markdown += generateVulnerabilityTable(vulns)\n      markdown += '\\n'\n    }\n  }\n\n  markdown += '---\\n\\n'\n  markdown += `*Report generated on: ${timestamp}*\\n\\n`\n  markdown += '*Powered by [Trivy](https://trivy.dev/)*\\n'\n\n  // Truncate if too large\n  if (markdown.length > MAX_ISSUE_BODY_SIZE) {\n    const truncateMessage =\n      '\\n\\n---\\n\\n‚ö†Ô∏è **Note:** This report was truncated due to size limitations. Please check the full Trivy report file for complete details.\\n'\n    markdown =\n      markdown.substring(0, MAX_ISSUE_BODY_SIZE - truncateMessage.length) +\n      truncateMessage\n  }\n\n  return markdown\n}\n\nexport type IssueResult = {\n  issueNumber: number | undefined\n  issueUrl: string | undefined\n  vulnerabilitiesFound: boolean\n}\n\n/**\n * Search for an existing issue with the given title\n */\nasync function findExistingIssue(\n  octokit: InstanceType<typeof GitHub>,\n  owner: string,\n  repo: string,\n  issueTitle: string,\n): Promise<number | null> {\n  try {\n    const { data: issues } = await octokit.rest.issues.listForRepo({\n      owner,\n      repo,\n      state: 'open',\n      creator: 'github-actions[bot]',\n      per_page: 100,\n    })\n\n    const existingIssue = issues.find((issue) => issue.title === issueTitle)\n    return existingIssue ? existingIssue.number : null\n  } catch (error) {\n    // If we can't search, we'll just create a new issue\n    console.warn('Failed to search for existing issues:', error)\n    return null\n  }\n}\n\n/**\n * Function that creates or updates a GitHub issue based on a Trivy report.\n * @param octokit The Octokit GitHub instance.\n * @param owner Repository owner\n * @param repo Repository name\n * @param trivyReport The parsed Trivy report\n * @param issueTitle The title for the issue\n * @param labels Optional labels to apply\n * @returns Issue number and URL\n */\nexport async function createOrUpdateIssue(\n  octokit: InstanceType<typeof GitHub>,\n  owner: string,\n  repo: string,\n  trivyReport: TrivyReport,\n  issueTitle: string,\n  labels?: string[],\n): Promise<IssueResult> {\n  // Count total vulnerabilities\n  const counts = countBySeverity(trivyReport)\n  const totalVulns = getTotalCount(counts)\n\n  // Search for existing issue\n  const existingIssueNumber = await findExistingIssue(\n    octokit,\n    owner,\n    repo,\n    issueTitle,\n  )\n\n  // If no vulnerabilities found, close existing issue if it exists\n  if (totalVulns === 0) {\n    if (existingIssueNumber) {\n      await octokit.rest.issues.update({\n        owner,\n        repo,\n        issue_number: existingIssueNumber,\n        state: 'closed',\n      })\n\n      const issueUrl = `https://github.com/${owner}/${repo}/issues/${existingIssueNumber}`\n      return {\n        issueNumber: existingIssueNumber,\n        issueUrl,\n        vulnerabilitiesFound: false,\n      }\n    }\n\n    // No existing issue and no vulnerabilities - nothing to do\n    return {\n      issueNumber: undefined,\n      issueUrl: undefined,\n      vulnerabilitiesFound: false,\n    }\n  }\n\n  // Generate markdown report\n  const markdownBody = generateMarkdownReport(trivyReport)\n\n  // Update existing issue\n  if (existingIssueNumber) {\n    await octokit.rest.issues.update({\n      owner,\n      repo,\n      issue_number: existingIssueNumber,\n      body: markdownBody,\n      labels: labels && labels.length > 0 ? labels : undefined,\n    })\n\n    const timestamp = new Date().toISOString()\n    await octokit.rest.issues.createComment({\n      owner,\n      repo,\n      issue_number: existingIssueNumber,\n      body: `üîÑ Report updated on ${timestamp}`,\n    })\n\n    const issueUrl = `https://github.com/${owner}/${repo}/issues/${existingIssueNumber}`\n    return {\n      issueNumber: existingIssueNumber,\n      issueUrl,\n      vulnerabilitiesFound: true,\n    }\n  }\n\n  // Create new issue\n  const { data: newIssue } = await octokit.rest.issues.create({\n    owner,\n    repo,\n    title: issueTitle,\n    body: markdownBody,\n    labels: labels && labels.length > 0 ? labels : undefined,\n  })\n\n  return {\n    issueNumber: newIssue.number,\n    issueUrl: newIssue.html_url,\n    vulnerabilitiesFound: true,\n  }\n}\n","import * as core from '@actions/core'\nimport { getOctokit, context } from '@actions/github'\nimport { parseTrivyReport } from './trivy.js'\nimport { createOrUpdateIssue } from './issue.js'\n\n/**\n * The main function for the action.\n * @returns {Promise<void>} Resolves when the action is complete.\n */\nexport async function run(): Promise<void> {\n  try {\n    const reportPath = core.getInput('report-path', { required: true })\n    const issueTitle = core.getInput('issue-title', { required: true })\n    const githubToken = core.getInput('github-token', { required: true })\n    const labelsInput = core.getInput('labels', { required: false })\n\n    const labels = labelsInput\n      ? labelsInput\n          .split(',')\n          .map((l) => l.trim())\n          .filter((l) => l.length > 0)\n      : []\n\n    const octokit = getOctokit(githubToken)\n    const { owner, repo } = context.repo\n\n    core.info(`üìÑ Parsing Trivy report from: ${reportPath}`)\n\n    const trivyReport = await parseTrivyReport(reportPath)\n\n    const { issueNumber, issueUrl, vulnerabilitiesFound } =\n      await createOrUpdateIssue(\n        octokit,\n        owner,\n        repo,\n        trivyReport,\n        issueTitle,\n        labels,\n      )\n\n    // 5. Set outputs\n    if (vulnerabilitiesFound) {\n      core.setOutput('issue-url', issueUrl)\n      core.info(`‚úÖ Issue #${issueNumber} updated successfully`)\n      core.info(`üîó ${issueUrl}`)\n    }\n  } catch (error) {\n    if (error instanceof Error) {\n      core.setFailed(`‚ùå Action failed: ${error.message}`)\n    } else {\n      core.setFailed('‚ùå An unknown error occurred')\n    }\n  }\n}\n","/**\n * The entrypoint for the action.\n */\nimport { run } from './main.js'\n\nrun()\n"],"mappings":"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"}