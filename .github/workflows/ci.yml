name: CI

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PNPM_VERSION: 10
  HUSKY: 0
  ACTIONLINT_VERSION: 1.7.8
jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v6
        with:
          node-version-file: ".node-version"
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint

      - name: Format Check
        run: pnpm run format:check

      - name: Typecheck
        run: pnpm run typecheck

      - name: Download actionlint
        run: |
          curl -sSL -o actionlint.tar.gz "https://github.com/rhysd/actionlint/releases/download/v${{ env.ACTIONLINT_VERSION }}/actionlint_${{ env.ACTIONLINT_VERSION }}_linux_amd64.tar.gz"
          tar -xzf actionlint.tar.gz
          chmod +x actionlint
          mv actionlint /usr/local/bin/

      - name: Lint GitHub Actions Workflows
        run: actionlint
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v6
        with:
          node-version-file: ".node-version"
          cache: pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Unit Tests
        run: pnpm run test

      - name: Test Local Action
        id: test-action
        uses: ./
        with:
          report-path: "example/trivy-result.json"
          issue-title: "Test Trivy Security Report"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          labels: "test,security"

      - name: Print Output
        id: output
        run: echo "Issue URL - ${{ steps.test-action.outputs.issue-url }}"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v5
        if: ${{ !cancelled() }}
        with:
          name: unit-test-results
          path: reports

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: brpaz/trivy-reporter-action
          directory: reports
